"use strict";
var __importDefault = (this && this.__importDefault) || function (mod) {
    return (mod && mod.__esModule) ? mod : { "default": mod };
};
Object.defineProperty(exports, "__esModule", { value: true });
const asn1_schema_1 = require("@peculiar/asn1-schema");
const asn1_x509_1 = require("@peculiar/asn1-x509");
const validateCertificatePath_1 = __importDefault(require("../../helpers/validateCertificatePath"));
const convertCertBufferToPEM_1 = __importDefault(require("../../helpers/convertCertBufferToPEM"));
const toHash_1 = __importDefault(require("../../helpers/toHash"));
const convertCOSEtoPKCS_1 = __importDefault(require("../../helpers/convertCOSEtoPKCS"));
async function verifyApple(options) {
    const { attStmt, authData, clientDataHash, credentialPublicKey, rootCertificates } = options;
    const { x5c } = attStmt;
    if (!x5c) {
        throw new Error('No attestation certificate provided in attestation statement (Apple)');
    }
    /**
     * Verify certificate path
     */
    try {
        await validateCertificatePath_1.default(x5c.map(convertCertBufferToPEM_1.default), rootCertificates);
    }
    catch (err) {
        throw new Error(`${err.message} (Apple)`);
    }
    /**
     * Compare nonce in certificate extension to computed nonce
     */
    const parsedCredCert = asn1_schema_1.AsnParser.parse(x5c[0], asn1_x509_1.Certificate);
    const { extensions, subjectPublicKeyInfo } = parsedCredCert.tbsCertificate;
    if (!extensions) {
        throw new Error('credCert missing extensions (Apple)');
    }
    const extCertNonce = extensions.find(ext => ext.extnID === '1.2.840.113635.100.8.2');
    if (!extCertNonce) {
        throw new Error('credCert missing "1.2.840.113635.100.8.2" extension (Apple)');
    }
    const nonceToHash = Buffer.concat([authData, clientDataHash]);
    const nonce = toHash_1.default(nonceToHash, 'SHA256');
    /**
     * Ignore the first six ASN.1 structure bytes that define the nonce as an OCTET STRING. Should
     * trim off <Buffer 30 24 a1 22 04 20>
     *
     * TODO: Try and get @peculiar (GitHub) to add a schema for "1.2.840.113635.100.8.2" when we
     * find out where it's defined (doesn't seem to be publicly documented at the moment...)
     */
    const extNonce = Buffer.from(extCertNonce.extnValue.buffer).slice(6);
    if (!nonce.equals(extNonce)) {
        throw new Error(`credCert nonce was not expected value (Apple)`);
    }
    /**
     * Verify credential public key matches the Subject Public Key of credCert
     */
    const credPubKeyPKCS = convertCOSEtoPKCS_1.default(credentialPublicKey);
    const credCertSubjectPublicKey = Buffer.from(subjectPublicKeyInfo.subjectPublicKey);
    if (!credPubKeyPKCS.equals(credCertSubjectPublicKey)) {
        throw new Error('Credential public key does not equal credCert public key (Apple)');
    }
    return true;
}
exports.default = verifyApple;
//# sourceMappingURL=verifyApple.js.map